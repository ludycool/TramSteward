

<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <script type="text/javascript" charset="utf-8" src="~/Content/js/ImgUp.js"></script>
      @section Jsprepare{  
  <script type="text/javascript">
      @Html.Raw(ViewBag.RuteUrl)
      var UserId = "";
      jQuery(document).ready(function () {

          BindUser();
      });


      function BindUser() {
             @Html.Raw(ViewBag.toolbar)
          $('#dg').datagrid({
              url: BaseUrl + 'GetList',
              columns: [[
                  { field: 'ck', checkbox: true },
              { field: 'CName', title: '姓名', width: 200 },
               { field: 'Version', title: '版本号', width: 100 },
                 {
                     field: 'Remarks', title: '备注', width: 300, align: 'right',
                     formatter: function (value) {

                         return StringSub(value, 20);
                     }
                 }, {
                     field: 'States', title: '状态', width: 120, align: 'right',
                     formatter: function (value) {
                         if (value == 0) {
                             var s = "可以不更新";
                             return s;
                         } else if (value == 1) {
                             var s = "强制更新";
                             return s;
                         }
                     }
                 },
                 {
                     field: 'Url', title: '文件', width: 120, align: 'right',
                     formatter: function (value) {

                         var url = '<a href="' + value + '"> 下载</a>'
                         return url;
                     }
                 }

              ]],
              nowrap: true,
              singleSelect: true,
              striped: true,
              collapsible: true,
              pagination: true,
              width: 'auto',
              height: 700,
              queryParams: { T: Math.floor(Math.random() * 1000000) },
              rownumbers: true,
              onLoadError: function () {
                  alert("没有数据");
              },
              toolbar: toolbars
          });

      }

      //easyUI 弹出添加医院的对话框
      function AddInfo() {
          //弹出层
          // $("#DivEditor").dialog('open').dialog('setTitle', '添加医院信息');
          $('#DivEditor').dialog({
              title: '添加医生信息',
              //width: 400,
              //height: 200,
              closed: false,
              cache: false,
              // href: 'get_content.php',
              modal: true,top: 100,
              onClose: function () {
                  //解决弹出窗口关闭后，验证消息还显示在最上面

              }
          });
          $("#ff").form("clear");
      }
      //实现医院的编辑，包括增查改
      function SaveInfo() {

          //判断医院的信息是否通过验证
          var validate = $("#ff").form('validate');
          if (validate == false) {
              return false;
          }
          //获取需要传递的参数传递给前台 push
          var postData = $("#ff").serializeArray();

          //发送异步请求到后台保存医院数据
          $.post(BaseUrl + 'EditInfo', postData, function (data) {
              if (data = "OK") {
                  //添加成功  1.关闭弹出层，2.刷新DataGird
                  alert("编辑成功");
                  $('#DivEditor').dialog('close');
                  $(".validatebox-tip").remove();
                  // $("#DivEditor").dialog("close");
                  $("#dg").datagrid("reload");
                  $("#ff").form("clear");
              }
              else {
                  alert("编辑失败，请您检查");
              }
          });

      }

      //修改医院的信息
      function EditInfo() {
          //首先取出来医院选择的数据的ID
          var rows = $("#dg").datagrid("getSelections");
          //首先取出来值判断医院只能选择一个
          if (rows.length != 1) {
              $.messager.alert("友情提示", "每次只能修改/浏览一条，你已经选择了<font color='red'  size='6'>" + rows.length + "</font>条", "error");
              return;
          }
          //处理修改的信息，弹出修改的对话框,然后显示选择的医院的详细信息
          $("#DivEditor").dialog('open').dialog('setTitle', '修改医院信息').window('resize', { top: 100 });
          //绑定修改显示详细信息的方法
          BindShowUpdateInfo();

      }

      //绑定修改显示详细信息的方法
      function BindShowUpdateInfo() {
          //首先医院发送一个异步请求去后台实现方法
          var ID = $("#dg").datagrid("getSelections")[0].Id;  //获取到了用医院选择的ID
          $.ajax({
              url: BaseUrl + 'GetInfo',
              type: 'POST',
              data: { ID: ID },
              cache: false,
              error: function () { alert('Error loading PHP document'); },
              success: function (result) {

                  DataBaseFunction.BindForm("ff", result);
                  $('#DeparTree').combotree('setValue', result['DepartmentId']);

              }
          });

      }
      //实现直接删除数据和伪删除数据的方法
      function Del() {
          //得到医院选择的数据的ID
          var rows = $("#dg").datagrid("getSelections");
          //首先判断医院是否已经选择了需要删除的数据,然后循环将医院选择的数据传递到后台
          if (rows.length >= 1) {
              //遍历出医院选择的数据的信息，这就是医院医院选择删除的医院ID的信息
              var ids = "";   //1,2,3,4,5
              for (var i = 0; i < rows.length; i++) {
                  //异步将删除的ID发送到后台，后台删除之后，返回前台，前台刷洗表格
                  ids += rows[i].Id + ",";
              }
              //最后去掉最后的那一个,
              ids = ids.substring(0, ids.length - 1);
              //获取医院选择的医院信息，如果医院选择了已经登录的医院的话需要给出不能删除的信息
              var CName = "";
              for (var i = 0; i < rows.length; i++) {
                  CName += rows[i].CName + ",";
              }
              CName = CName.substring(0, CName.length - 1);
              //首先取出来到底是直接删除还是伪删除发送异步请求的地址和是否是伪删除的参数
              var postData = "";

              postData = {
                  ID: ids
              };
              //}
              //else {
              //    postData = {
              //        ID: ids, Not: not
              //    }
              //}
              //然后确认发送异步请求的信息到后台删除数据
              $.messager.confirm("删除信息", "您确认删除<font color='red' size='3'>" + CName + "</font>医院吗？", function (DeleteRole) {
                  if (DeleteRole) {
                      $.get(BaseUrl + "DeleteInfo", postData, function (data) {
                          if (data == "OK") {
                              //友情提示医院删除成功，刷新表格
                              $.messager.alert("友情提示", "删除/还原成功");
                              $("#dg").datagrid("reload");
                              //当删除完成之后，第二次删除的时候还记得上次的信息，这样是不可以的，所以我们需要清除第一次的信息
                              //第一种方法
                              rows.length = "";
                              //第二种方法
                              $("#dg").datagrid("clearSelections");
                          }
                          else {
                              $.messager.alert("友情提示", data);
                          }
                      });
                  }
              });
          }
          else {
              alert("请选择你要删除的数据");
          }
      }
      function FileHeadSave() {
          //----上传头像
          var FileId = "";

          $("#ff").form('submit', {
              url: "/httpHandle/UploadHandler.ashx?action=addFile&SourceTable=AppVersion",
              onSubmit: function () {

              },
              success: function (data) {
                  var d = eval('(' + data + ')');
                  if (d.Success) {
                      var imgList = eval('(' + d.Data + ')');
                      $("input[name='Url']").val(imgList[0].FullRoute)
                  }
                  else {
                      msg.warning(data.Message);
                  }

              }
          })
      }
      function fotmale(obj) {
          //先把非数字的都替换掉，除了数字和. 
          obj.value = obj.value.replace(/[^\d.]/g, "");
          //必须保证第一个为数字而不是. 
          obj.value = obj.value.replace(/^\./g, "");
          //保证只有出现一个.而没有多个. 
          obj.value = obj.value.replace(/\.{2,}/g, ".");
      }
</script>
           }
</head>
<body>

    <div  class="easyui-layout" style="width:1200px;height:800px;">
    <div region="center" title="用户" style="padding:5px;background:#eee;" iconCls: 'icon-user_earth'><table id="dg" ></table></div>
     </div>
    <div id="DivEditor" class="easyui-dialog" style="width:580px;height:335px;padding:10px 20px"
         closed="true" resizable="true" modal="true" buttons="#dlg-buttons">
              <form id="ff" method="post" enctype="multipart/form-data">
            <fieldset>
                <legend>信息填写栏</legend>
                <table id="tblAdd"><input  type="hidden"  name="Id" />
                    <input  type="hidden"  name="AddTime" />
                     <input  type="hidden"  name="UpdateTime" />
                    <tr><td><label >名称：</label></td><td><input  type="text"  name="CName" /></td></tr>
                    <tr>
                        <td>
                            <label>文件路径：</label></td>
                        <td>
                            <input type="text" name="Url" style="width:400px;" /></td>
                        <td >
                           
                        </td>
                    </tr>                   <tr>
                        <td>
                            <label>状态：</label></td>
                        <td>
                            <select name="States">
                                <option value='0'>可以不更新</option>
                                <option value='1'>强制更新</option>
                            </select></td>
                    </tr>
<tr><td><label >版本号：</label></td><td><input  type="text"  name="Version" onkeyup="fotmale(this);" />(数字格式：00.00.00)</td></tr>
<tr><td><label >备注：</label></td><td><textarea name="Remarks" cols="20" rows="2"></textarea></td></tr>
                    <tr>
                        <td colspan="4" style="text-align:center; padding-top:10px">
                            <a href="javascript:void(0)" class="easyui-linkbutton" id="btnAddRole" iconcls="icon-ok"  onclick="SaveInfo();" >确定</a>
                            <a href="javascript:void(0)" class="easyui-linkbutton" iconcls="icon-cancel" onclick="$('#DivEditor').dialog('close')">关闭</a>
                        </td>
                    </tr>
                </table>
            </fieldset>
        </form>
    </div>
 


</body>
</html>
